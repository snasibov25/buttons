{% extends "base.html" %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    /* RETRO WAVE BACKGROUND */
    .synth-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: linear-gradient(to bottom, #12001f 0%, #180029 60%, #24003d 100%);
        overflow: hidden;
    }

    /* THE GRID FLOOR */
    .grid-floor {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
        background-image: 
            linear-gradient(rgba(255, 0, 255, 0.3) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 0, 255, 0.3) 1px, transparent 1px);
        background-size: 40px 40px;
        perspective: 500px;
        transform: perspective(300px) rotateX(60deg) scale(2);
        transform-origin: bottom center;
        animation: moveGrid 10s linear infinite;
        opacity: 0.5;
    }

    @keyframes moveGrid {
        from { background-position: 0 0; }
        to { background-position: 0 40px; }
    }

    /* THE SUN */
    .retro-sun {
        position: absolute;
        top: 15%;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(to bottom, #ffcc00, #ff0055);
        box-shadow: 0 0 40px #ff0055;
        z-index: -1;
    }

    /* UI CONTAINER */
    .deck-container {
        position: relative;
        width: 90%;
        max-width: 800px;
        margin: 40px auto;
        background: rgba(0,0,0,0.6);
        border: 2px solid #00f2ff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        backdrop-filter: blur(5px);
    }

    h2 {
        font-family: 'Press Start 2P', cursive;
        color: #00f2ff;
        text-shadow: 3px 3px 0 #ff0055;
        margin-bottom: 20px;
        text-transform: uppercase;
        font-size: 1.5rem;
    }

    /* VISUALIZER */
    canvas {
        width: 100%;
        height: 100px;
        background: #111;
        border-radius: 5px;
        border: 1px solid #333;
        margin-bottom: 20px;
    }

    /* PAD GRID */
    .pad-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }

    .synth-pad {
        aspect-ratio: 1;
        background: #222;
        border: 2px solid #444;
        border-radius: 8px;
        color: #666;
        font-family: monospace;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.05s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        user-select: none;
    }

    .key-hint {
        font-size: 10px;
        opacity: 0.5;
        margin-top: 5px;
    }

    /* ACTIVE STATES */
    .synth-pad:active, .synth-pad.active {
        background: #fff;
        border-color: #fff;
        box-shadow: 0 0 20px #fff;
        color: #000;
        transform: scale(0.95);
    }

    /* Colors for different notes */
    .pad-blue:active, .pad-blue.active { background: #00f2ff; border-color: #00f2ff; box-shadow: 0 0 20px #00f2ff; }
    .pad-pink:active, .pad-pink.active { background: #ff0055; border-color: #ff0055; box-shadow: 0 0 20px #ff0055; }
    .pad-purple:active, .pad-purple.active { background: #bd00ff; border-color: #bd00ff; box-shadow: 0 0 20px #bd00ff; }

</style>

<div class="synth-bg">
    <div class="retro-sun"></div>
    <div class="grid-floor"></div>
</div>

<div class="deck-container">
    <h2>Neon Deck</h2>
    
    <canvas id="visualizer"></canvas>

    <div class="pad-grid">
        <div class="synth-pad pad-blue" onmousedown="play(261.63, 'pad1')" id="pad1">C4<span class="key-hint">[A]</span></div>
        <div class="synth-pad pad-blue" onmousedown="play(293.66, 'pad2')" id="pad2">D4<span class="key-hint">[S]</span></div>
        <div class="synth-pad pad-blue" onmousedown="play(329.63, 'pad3')" id="pad3">E4<span class="key-hint">[D]</span></div>
        <div class="synth-pad pad-blue" onmousedown="play(349.23, 'pad4')" id="pad4">F4<span class="key-hint">[F]</span></div>
        
        <div class="synth-pad pad-pink" onmousedown="play(392.00, 'pad5')" id="pad5">G4<span class="key-hint">[G]</span></div>
        <div class="synth-pad pad-pink" onmousedown="play(440.00, 'pad6')" id="pad6">A4<span class="key-hint">[H]</span></div>
        <div class="synth-pad pad-pink" onmousedown="play(493.88, 'pad7')" id="pad7">B4<span class="key-hint">[J]</span></div>
        <div class="synth-pad pad-pink" onmousedown="play(523.25, 'pad8')" id="pad8">C5<span class="key-hint">[K]</span></div>
    </div>
    
    <p style="color:#fff; opacity:0.6; font-size:12px; margin-top:20px;">
        Click pads or use keyboard (A-K) to play.
    </p>
</div>

<script>
    // --- AUDIO ENGINE ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    
    // Create Analyser for Visualizer
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 256;
    analyser.connect(ctx.destination); // Master Out

    // Add a global Delay effect (Echo)
    const delayNode = ctx.createDelay();
    delayNode.delayTime.value = 0.3; // 300ms delay
    
    const feedbackNode = ctx.createGain();
    feedbackNode.gain.value = 0.3; // 30% feedback
    
    delayNode.connect(feedbackNode);
    feedbackNode.connect(delayNode);
    delayNode.connect(analyser); // Connect delay to output

    function play(freq, id) {
        if(ctx.state === 'suspended') ctx.resume();

        // Visual feedback
        const btn = document.getElementById(id);
        btn.classList.add('active');
        setTimeout(() => btn.classList.remove('active'), 150);

        // Oscillator (The Sound Source)
        const osc = ctx.createOscillator();
        osc.type = 'sawtooth'; // Sawtooth sounds very "Synthwave"
        osc.frequency.setValueAtTime(freq, ctx.currentTime);

        // Filter (The "Wah" sound)
        const filter = ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(200, ctx.currentTime);
        filter.frequency.exponentialRampToValueAtTime(3000, ctx.currentTime + 0.05); // Attack
        filter.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.5); // Decay

        // Gain (Volume Envelope)
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.02); // Attack
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5); // Decay

        // Connections
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(analyser); // Direct sound
        gain.connect(delayNode); // Echo sound

        // Start/Stop
        osc.start();
        osc.stop(ctx.currentTime + 1); // Auto stop after 1 second
    }

    // --- KEYBOARD MAPPING ---
    const keyMap = {
        'a': {f: 261.63, id: 'pad1'},
        's': {f: 293.66, id: 'pad2'},
        'd': {f: 329.63, id: 'pad3'},
        'f': {f: 349.23, id: 'pad4'},
        'g': {f: 392.00, id: 'pad5'},
        'h': {f: 440.00, id: 'pad6'},
        'j': {f: 493.88, id: 'pad7'},
        'k': {f: 523.25, id: 'pad8'}
    };

    window.addEventListener('keydown', (e) => {
        const k = e.key.toLowerCase();
        if(keyMap[k]) {
            play(keyMap[k].f, keyMap[k].id);
        }
    });

    // --- VISUALIZER LOOP ---
    const canvas = document.getElementById('visualizer');
    const cCtx = canvas.getContext('2d');
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
        requestAnimationFrame(draw);
        
        analyser.getByteFrequencyData(dataArray);

        // Clear canvas
        cCtx.fillStyle = '#111';
        cCtx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;

        for(let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i] / 2; // Scale down

            // Cyberpunk Gradient
            cCtx.fillStyle = `rgb(${barHeight + 100}, 0, ${255 - barHeight})`;
            cCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

            x += barWidth + 1;
        }
    }

    // Fix Canvas Scaling
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    // Start Visualizer
    draw();

</script>
{% endblock %}